import{_ as f,o as m,c as h,b as o,F as p,d as g,t as d,f as u,g as _,v as w,p as A,h as T}from"./index-BkKvcv0a.js";const O={data(){return{alarms:[{label:"第一排走道ON",time:"",alarmOn:!1,nextAlarm:"",period:"上午"},{label:"第二排走道ON",time:"",alarmOn:!1,nextAlarm:"",period:"上午"},{label:"第三排走道ON",time:"",alarmOn:!1,nextAlarm:"",period:"上午"},{label:"第一排走道OFF",time:"",alarmOn:!1,nextAlarm:"",period:"上午"},{label:"第二排走道OFF",time:"",alarmOn:!1,nextAlarm:"",period:"上午"},{label:"第三排走道OFF",time:"",alarmOn:!1,nextAlarm:"",period:"上午"}],esp8266Time:"",hasPermission:!1,userName:"",ipAddress:"192.168.50.1",intervalId:null}},mounted(){this.getFormDataFromServer(),this.getTimeFromESP8266(),this.checkPermission(),this.fetchUserInfo(),this.startInterval()},beforeUnmount(){clearInterval(this.intervalId)},methods:{startInterval(){this.updateAllAlarms(),this.intervalId=setInterval(this.getTimeFromESP8266,1e3)},updateAllAlarms(){this.alarms.forEach((e,t)=>{this.calculateNextAlarm(t)})},calculateNextAlarm(e){const t=this.alarms[e];if(!t.time){t.nextAlarm="尚未設定";return}const a=new Date,[s,n]=t.time.split(":").map(Number);let r=new Date(a.getFullYear(),a.getMonth(),a.getDate(),s,n);r<a&&r.setDate(r.getDate()+1);const i=r-a,l=Math.floor(i/(1e3*60*60)),c=Math.floor(i%(1e3*60*60)/(1e3*60));t.nextAlarm=`在 ${l} 小時 ${c} 分鐘`},handleTimeChange(e){this.calculateNextAlarm(e),this.alarms[e].alarmOn&&(this.updateAlarm(e),this.logAction("時間設定",this.userName,this.getTaiwanISOTime(),`更新時間 ${e+1}`,this.ipAddress))},handleToggleChange(e){const t=this.alarms[e];this.updateAlarm(e),this.calculateNextAlarm(e),this.logAction("開關狀態",this.userName,this.getTaiwanISOTime(),`切換開關 ${e+1} 到 ${t.alarmOn?"開啟":"關閉"}`,this.ipAddress)},updateAlarm(e){const t=this.alarms[e],a=new URLSearchParams({[`time${e+1}`]:t.time||"",[`alarmOn${e+1}`]:t.alarmOn}).toString();fetch("/timeset",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:a}).then(s=>s.text()).then(s=>{console.log("鬧鐘數據更新成功")}).catch(s=>{console.error("更新鬧鐘數據時出錯：",s)})},getTimeFromESP8266(){fetch("/time").then(e=>e.text()).then(e=>{if(e.includes("<html"))throw new Error("連線錯誤");this.esp8266Time=e}).catch(e=>{console.error("錯誤: "+e),this.esp8266Time="連線錯誤"})},async getFormDataFromServer(){try{const e=await fetch("/get_timeset");if(!e.ok)throw new Error("取得表單資料失敗");const t=await e.json();this.alarms=this.alarms.map((a,s)=>({...a,time:t[`time${s+1}`]||"",alarmOn:t[`alarmOn${s+1}`]||!1})),this.updateAllAlarms()}catch(e){console.error(`取得表單資料錯誤：${e}`)}},async checkPermission(){try{const e=await fetch("/function2");if(!e.ok)throw new Error("網絡響應異常");const t=await e.json();this.hasPermission=t.function2===1,this.hasPermission||alert("您沒有權限執行此操作！")}catch(e){console.error(`錯誤：${e}`)}},async fetchUserInfo(){try{const e=await fetch("/get_user_info");if(!e.ok)throw new Error("網絡響應異常");const t=await e.json();this.userName=t.name}catch(e){console.error(`獲取用戶信息錯誤：${e}`)}},getTaiwanISOTime(){const e=new Date,t={timeZone:"Asia/Taipei",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1},[a,s]=e.toLocaleString("en-GB",t).split(", "),[n,r,i]=a.split("/");return`${i}-${r}-${n},${s}`},async logAction(e,t,a,s,n){try{if(!(await fetch("/logs",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({function:e,username:t,date:a,action:s,ip:n})})).ok)throw new Error("記錄失敗");console.log("記錄成功")}catch(r){console.error(`記錄錯誤：${r}`)}}}},v=e=>(A("data-v-28254fec"),e=e(),T(),e),y={class:"alarms-container"},b={class:"alarm-header"},S={class:"time"},F=["onUpdate:modelValue","onChange","disabled"],I={class:"period"},$={class:"toggle-switch"},D=["id","onUpdate:modelValue","onChange","disabled"],P=["for"],k={class:"alarm-info"},N={class:"next-alarm"},x={class:"alarm-label"},C={class:"chip-time-container"},E=v(()=>o("h3",null,"晶片時間:",-1)),U={key:0,class:"chip-time"},M={key:1,class:"chip-time"};function V(e,t,a,s,n,r){return m(),h(p,null,[o("div",y,[(m(!0),h(p,null,g(n.alarms,(i,l)=>(m(),h("div",{key:l,class:"alarm-card"},[o("div",b,[o("div",S,[u(o("input",{type:"time","onUpdate:modelValue":c=>i.time=c,class:"time-input",onChange:c=>r.handleTimeChange(l),disabled:!n.hasPermission},null,40,F),[[_,i.time]]),o("span",I,d(i.period),1)]),o("div",$,[u(o("input",{type:"checkbox",id:"alarmToggle"+l,"onUpdate:modelValue":c=>i.alarmOn=c,onChange:c=>r.handleToggleChange(l),disabled:!n.hasPermission},null,40,D),[[w,i.alarmOn]]),o("label",{for:"alarmToggle"+l},null,8,P)])]),o("div",k,[o("span",N,"⏰ "+d(i.nextAlarm||"尚未設定"),1),o("span",x,d(i.label),1)])]))),128))]),o("div",C,[E,n.esp8266Time?(m(),h("p",U,d(n.esp8266Time),1)):(m(),h("p",M,"連線錯誤"))])],64)}const L=f(O,[["render",V],["__scopeId","data-v-28254fec"]]);export{L as default};
