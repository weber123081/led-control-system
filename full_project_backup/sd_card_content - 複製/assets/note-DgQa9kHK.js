import{_ as f,o as m,c as h,b as r,F as p,d as g,t as d,f as u,g as _,v as w,p as A,h as T}from"./index-BkKvcv0a.js";const O={data(){return{alarms:[{label:"第一排走道ON",time:"",alarmOn:!1,nextAlarm:"",period:"上午"},{label:"第二排走道ON",time:"",alarmOn:!1,nextAlarm:"",period:"上午"},{label:"第三排走道ON",time:"",alarmOn:!1,nextAlarm:"",period:"上午"},{label:"第一排走道OFF",time:"",alarmOn:!1,nextAlarm:"",period:"上午"},{label:"第二排走道OFF",time:"",alarmOn:!1,nextAlarm:"",period:"上午"},{label:"第三排走道OFF",time:"",alarmOn:!1,nextAlarm:"",period:"上午"}],esp8266Time:"",hasPermission:!0,userName:"",ipAddress:"192.168.50.1",intervalId:null}},mounted(){this.getFormDataFromServer(),this.getTimeFromESP8266(),this.checkPermission(),this.fetchUserInfo(),this.startInterval()},beforeUnmount(){clearInterval(this.intervalId)},methods:{startInterval(){this.updateAllAlarms(),this.intervalId=setInterval(this.getTimeFromESP8266,1e3)},updateAllAlarms(){this.alarms.forEach((e,t)=>{this.calculateNextAlarm(t)})},calculateNextAlarm(e){const t=this.alarms[e];if(!t.time){t.nextAlarm="尚未設定";return}const s=new Date,[a,i]=t.time.split(":").map(Number);let o=new Date(s.getFullYear(),s.getMonth(),s.getDate(),a,i);o<s&&o.setDate(o.getDate()+1);const n=o-s,l=Math.floor(n/(1e3*60*60)),c=Math.floor(n%(1e3*60*60)/(1e3*60));t.nextAlarm=`在 ${l} 小時 ${c} 分鐘`},handleTimeChange(e){this.updateAlarm(e),this.calculateNextAlarm(e),this.logAction("時間設定",this.userName,this.getTaiwanISOTime(),`更新時間 ${e+1}`,this.ipAddress)},handleToggleChange(e){const t=this.alarms[e];t.alarmOn||(t.time=""),this.updateAlarm(e),this.calculateNextAlarm(e),this.logAction("開關狀態",this.userName,this.getTaiwanISOTime(),`切換開關 ${e+1} 到 ${t.alarmOn?"開啟":"關閉"}`,this.ipAddress)},updateAlarm(e){const t=this.alarms[e],s=new URLSearchParams({[`time${e+1}`]:t.time||"",alarmOn:t.alarmOn}).toString();fetch("/update_alarm",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:s}).then(a=>a.text()).then(a=>{console.log("鬧鐘數據更新成功")}).catch(a=>{console.error("更新鬧鐘數據時出錯：",a)})},getTimeFromESP8266(){fetch("/time").then(e=>e.text()).then(e=>{if(e.includes("<html"))throw new Error("連線錯誤");this.esp8266Time=e}).catch(e=>{console.error("錯誤: "+e),this.esp8266Time="連線錯誤"})},async getFormDataFromServer(){try{const e=await fetch("/get_timeset");if(!e.ok)throw new Error("取得表單資料失敗");const t=await e.json();this.alarms=this.alarms.map((s,a)=>({...s,time:t[`time${a+1}`]||"",nextAlarm:t[`nextAlarm${a+1}`]||"",alarmOn:t[`alarmOn${a+1}`]==="true"})),this.updateAllAlarms()}catch(e){console.error(`取得表單資料錯誤：${e}`)}},async checkPermission(){try{const e=await fetch("/function2");if(!e.ok)throw new Error("網絡響應異常");const t=await e.json();this.hasPermission=t.function2===1,this.hasPermission||alert("您沒有權限執行此操作！")}catch(e){console.error(`錯誤：${e}`)}},async fetchUserInfo(){try{const e=await fetch("/get_user_info");if(!e.ok)throw new Error("網絡響應異常");const t=await e.json();this.userName=t.name}catch(e){console.error(`獲取用戶信息錯誤：${e}`)}},getTaiwanISOTime(){const e=new Date,t={timeZone:"Asia/Taipei",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1},[s,a]=e.toLocaleString("en-GB",t).split(", "),[i,o,n]=s.split("/");return`${n}-${o}-${i},${a}`},async logAction(e,t,s,a,i){try{if(!(await fetch("/logs",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({function:e,username:t,date:s,action:a,ip:i})})).ok)throw new Error("記錄失敗");console.log("記錄成功")}catch(o){console.error(`記錄錯誤：${o}`)}}}},b=e=>(A("data-v-98bb206e"),e=e(),T(),e),v={class:"alarms-container"},y={class:"alarm-header"},S={class:"time"},F=["onUpdate:modelValue","onChange","disabled"],I={class:"period"},$={class:"toggle-switch"},x=["id","onUpdate:modelValue","onChange","disabled"],D=["for"],P={class:"alarm-info"},k={class:"next-alarm"},N={class:"alarm-label"},C={class:"chip-time-container"},E=b(()=>r("h3",null,"晶片時間:",-1)),U={key:0,class:"chip-time"},M={key:1,class:"chip-time"};function V(e,t,s,a,i,o){return m(),h(p,null,[r("div",v,[(m(!0),h(p,null,g(i.alarms,(n,l)=>(m(),h("div",{key:l,class:"alarm-card"},[r("div",y,[r("div",S,[u(r("input",{type:"time","onUpdate:modelValue":c=>n.time=c,class:"time-input",onChange:c=>o.handleTimeChange(l),disabled:!i.hasPermission},null,40,F),[[_,n.time]]),r("span",I,d(n.period),1)]),r("div",$,[u(r("input",{type:"checkbox",id:"alarmToggle"+l,"onUpdate:modelValue":c=>n.alarmOn=c,onChange:c=>o.handleToggleChange(l),disabled:!i.hasPermission},null,40,x),[[w,n.alarmOn]]),r("label",{for:"alarmToggle"+l},null,8,D)])]),r("div",P,[r("span",k,"⏰ "+d(n.nextAlarm||"尚未設定"),1),r("span",N,d(n.label),1)])]))),128))]),r("div",C,[E,i.esp8266Time?(m(),h("p",U,d(i.esp8266Time),1)):(m(),h("p",M,"連線錯誤"))])],64)}const L=f(O,[["render",V],["__scopeId","data-v-98bb206e"]]);export{L as default};
